<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Booking Kendaraan</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
  <!-- LOGIN -->
  <div id="loginPage">
    <h2>Login Admin</h2>
    <form id="loginForm">
      <div class="form-group"><label>Email</label><input type="text" name="username" required></div>
      <div class="form-group"><label>Password</label><input type="password" name="password" required></div>
      <button type="submit">Login</button>
    </form>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboardPage" class="hidden">
    <button class="logout-btn" onclick="logout()">Logout</button>
    <h2>Dashboard</h2>
    <div class="dashboard-menu">
      <button class="card-btn" onclick="showNewBookingForm()">Booking Kendaraan</button>
      <button class="card-btn" onclick="showPage('dataPage')">Data Booking</button>
      <button class="card-btn" onclick="showPage('rekapPage')">Rekap Show/No Show/Reschedule</button>
      <button class="card-btn" onclick="showPage('rekapSalesPage')">Rekap Sales</button>
      <button class="card-btn" onclick="showPage('mrsPage')">MRS (Monthly Reminder System)</button>
    </div>
  </div>

  <!-- FORM BOOKING -->
  <div id="bookingPage" class="hidden">
    <button onclick="showPage('dashboardPage')">&larr; Kembali</button>
    <h3>Form Booking</h3>
    <form id="bookingForm">
      <input type="hidden" name="editId" id="editId" />
      <input type="hidden" name="sheetName" id="sheetName" />
      <div class="form-group"><label>Nomor Polisi</label><input type="text" name="plat" required /></div>
      <div class="form-group hidden" id="statusGroup">
        <label>Status Kehadiran</label>
        <select name="status_kehadiran" id="status_kehadiran_select">
          <option value="show">show</option>
          <option value="no show">no show</option>
          <option value="reschedule">reschedule</option>
        </select>
      </div>
      <div class="form-group"><label>Tipe Kendaraan</label><input type="text" name="tipe" required /></div>
      <div class="form-group"><label>Tahun</label><input type="text" name="tahun" required /></div>
      <div class="form-group">
        <label>Tipe Telepon</label>
        <select name="tipe_telepon" id="tipe_telepon" required onchange="togglePhoneInput()">
          <option value="">Pilih Tipe Telepon</option>
          <option value="TELP">TELP</option>
          <option value="SA">SA</option>
        </select>
      </div>
      <div class="form-group" id="phoneInputGroup">
        <label>No HP</label>
        <div style="display: flex; align-items: center;">
          <span style="background: #f0f0f0; padding: 10px; border: 1px solid #ccc; border-right: none; border-radius: 5px 0 0 5px; color: #666;">62</span>
          <input type="text" name="nohp" id="nohp_input" placeholder="81298292" style="border-radius: 0 5px 5px 0; border-left: none;" required />
        </div>
      </div>
      <div class="form-group" id="saPhoneGroup" style="display: none;">
        <label>SA</label>
        <select name="nohp_sa" id="nohp_sa_select">
          <option value="">Pilih SA</option>
          <option value="DB">DB</option>
          <option value="DM">DM</option>
          <option value="DR">DR</option>
          <option value="PS">PS</option>
          <option value="RZ">RZ</option>
        </select>
      </div>
      <div class="form-group" id="customerDatangGroup">
        <label>Customer Akan Datang</label>
        <input type="text" name="datang" id="datang_input" placeholder="Nama customer yang akan datang" required />
      </div>
      <div class="form-group" id="customerDatangDropdown" style="display: none;">
        <label>Customer Akan Datang</label>
        <select name="datang_dropdown" id="datang_select">
          <option value="">Pilih Customer</option>
          <option value="DB">DB</option>
          <option value="DM">DM</option>
          <option value="DR">DR</option>
          <option value="PS">PS</option>
          <option value="RZ">RZ</option>
        </select>
      </div>
      <div class="form-group"><label>Nama Customer</label><input type="text" name="nama" required /></div>
      <div class="form-group"><label>Tanggal Penerimaan</label><input type="date" name="tanggal_penerimaan" required /></div>
      <div class="form-group"><label>Jam Penerimaan</label><input type="time" name="jam_penerimaan" required /></div>
      <div class="form-group"><label>VIA</label>
        <select name="via" required>
          <option value="AW">AW</option>
          <option value="SA">SA</option>
          <option value="TAB">TAB</option>
          <option value="MRS">MRS</option>
          <option value="TLP">TLP</option>
        </select>
      </div>
      <div class="form-group"><label>Admin</label>
        <select name="admin" required>
          <option value="Frenty">Frenty</option>
          <option value="Risa">Risa</option>
          <option value="AW">AW</option>
        </select>
      </div>
      <div class="form-group"><label>Jenis Pekerjaan</label><textarea name="keluhan" required></textarea></div>
      <div class="form-group"><label>Nama Sales (Opsional)</label>
        <select name="sales" id="sales_select" onchange="toggleOtherSalesBooking()">
          <option value="">Pilih Sales</option>
          <option value="zen">Zen</option>
          <option value="januar">Januar</option>
          <option value="nia">Nia</option>
          <option value="avro">Avro</option>
          <option value="mila">Mila</option>
          <option value="indra">Indra</option>
          <option value="hendra">Hendra</option>
          <option value="irvan">Irvan</option>
          <option value="rony">Rony</option>
          <option value="stevy">Stevy</option>
          <option value="osla">Osla</option>
          <option value="imron">Imron</option>
          <option value="asep aj">Asep AJ</option>
          <option value="nadia">Nadia</option>
          <option value="daulat">Daulat</option>
          <option value="other">Other</option>
        </select>
        <input type="text" name="sales_other" id="sales_other_input" placeholder="Nama Sales Lain" style="display:none;margin-top:4px;" />
      </div>
      <button type="submit" id="submitBtn">Kirim</button>
    </form>
  </div>

  <!-- DATA -->
  <div id="dataPage" class="hidden">
    <button onclick="showPage('dashboardPage')">&larr; Kembali</button>
    <h3>Data Booking</h3>
    <div>
      <label>Filter Tanggal: <input type="date" id="filter-date" /></label>
      <button onclick="loadData()">Lihat Data</button>
    </div>
    <div class="table-responsive">
      <table id="dataTable" class="hidden">
        <thead>
          <tr>
            <th>No</th>
            <th>Status</th>
            <th>Plat</th>
            <th>Tipe</th>
            <th>Tahun</th>
            <th>HP</th>
            <th>Datang</th>
            <th>Nama</th>
            <th>Tanggal Booking</th>
            <th>Tanggal Penerimaan</th>
            <th>Jam Penerimaan</th>
            <th>Via</th>
            <th>Admin</th>
            <th>Keluhan</th>
            <th>Sales</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- REKAP -->
  <div id="rekapPage" class="hidden">
    <button onclick="showPage('dashboardPage')">&larr; Kembali</button>
    <h3>Rekap Show/No Show/Reschedule</h3>
    <div>
      <label>Filter Tanggal: <input type="date" id="rekap-filter-date" /></label>
      <button onclick="loadRekap()">Lihat Rekap</button>
      <button onclick="exportRekapToSpreadsheet()" id="exportBtn" class="hidden">Export ke Spreadsheet</button>
    </div>
    <div id="rekapSummary" class="hidden">
      <h4>Ringkasan</h4>
      <div style="display: flex; gap: 20px; margin: 20px 0; flex-wrap: wrap;">
        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; min-width: 120px;">
          <strong>Show:</strong> <span id="showCount">0</span>
        </div>
        <div style="background: #ffe8e8; padding: 15px; border-radius: 8px; min-width: 120px;">
          <strong>No Show:</strong> <span id="noShowCount">0</span>
        </div>
        <div style="background: #fff3e8; padding: 15px; border-radius: 8px; min-width: 120px;">
          <strong>Reschedule:</strong> <span id="rescheduleCount">0</span>
        </div>
        <div style="background: #f0f0f0; padding: 15px; border-radius: 8px; min-width: 120px;">
          <strong>Total:</strong> <span id="totalCount">0</span>
        </div>
      </div>
    </div>
    <div class="table-responsive">
      <table id="rekapTable" class="hidden">
        <thead>
          <tr>
            <th>No</th>
            <th>Status</th>
            <th>Plat</th>
            <th>Nama Customer</th>
            <th>Tanggal Penerimaan</th>
            <th>Jam Penerimaan</th>
            <th>Via</th>
            <th>Admin</th>
            <th>Sales</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- REKAP SALES -->
  <div id="rekapSalesPage" class="hidden">
    <button onclick="showPage('dashboardPage')">&larr; Kembali</button>
    <h3>Rekap Sales</h3>
    <div style="margin: 20px 0;">
      <label>Pilih Bulan: 
        <select id="rekap-sales-month">
          <option value="">Semua Bulan</option>
          <option value="01">Januari</option>
          <option value="02">Februari</option>
          <option value="03">Maret</option>
          <option value="04">April</option>
          <option value="05">Mei</option>
          <option value="06">Juni</option>
          <option value="07">Juli</option>
          <option value="08">Agustus</option>
          <option value="09">September</option>
          <option value="10">Oktober</option>
          <option value="11">November</option>
          <option value="12">Desember</option>
        </select>
      </label>
      <label>Tahun: 
        <input type="number" id="rekap-sales-year" min="2020" max="2100" value="2025" style="width:80px; margin-left:10px;" />
      </label>
      <div style="margin-top: 20px;">
        <button onclick="loadRekapSales()" class="card-btn" style="margin: 10px;">VIEW REKAP</button>
        <button onclick="showPage('infoCustomerPage')" class="card-btn" style="margin: 10px;">VIEW INFO CUSTOMER</button>
        <button onclick="showSalesCharts()" class="card-btn" style="margin: 10px;">LIHAT GRAFIK</button>
        <button onclick="updateSalesRekapSpreadsheet()" class="card-btn" style="margin: 10px; background: #28a745;">UPDATE SPREADSHEET</button>
      </div>
    </div>
    <div id="rekapSalesTableContainer" class="table-responsive"></div>
    <div id="salesChartsContainer" class="hidden" style="margin-top: 30px;">
      <div style="display: flex; gap: 20px; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 300px;">
          <h4>Pie Chart - Distribusi Sales</h4>
          <canvas id="salesPieChart" width="400" height="400"></canvas>
        </div>
        <div style="flex: 1; min-width: 300px;">
          <h4>Bar Chart - Perbandingan Sales</h4>
          <canvas id="salesBarChart" width="400" height="400"></canvas>
        </div>
      </div>
      <div id="salesSummary" style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 8px;">
        <h4>Ringkasan</h4>
        <div id="salesSummaryContent"></div>
      </div>
    </div>
  </div>

  <!-- MRS (Monthly Reminder System) -->
  <div id="mrsPage" class="hidden">
    <button onclick="showPage('dashboardPage')">&larr; Kembali</button>
    <h3>MRS (Monthly Reminder System)</h3>
    <div style="margin: 20px 0;">
      <button onclick="showPage('mrsInputPage')" class="card-btn" style="margin: 10px;">Input MRS</button>
      <button onclick="showPage('mrsViewPage')" class="card-btn" style="margin: 10px;">View MRS</button>
    </div>
  </div>

  <!-- MRS INPUT -->
  <div id="mrsInputPage" class="hidden">
    <button onclick="showPage('mrsPage')">&larr; Kembali</button>
    <h3>Input MRS</h3>
    <form id="mrsForm">
      <div class="form-group">
        <label>Nomor Polisi</label>
        <input type="text" name="plat_mrs" required />
      </div>
      <div class="form-group">
        <label>Bulan</label>
        <select name="reminder_month" id="reminder_month_select" required>
          <option value="">Pilih Bulan</option>
          <option value="Januari">Januari</option>
          <option value="Februari">Februari</option>
          <option value="Maret">Maret</option>
          <option value="April">April</option>
          <option value="Mei">Mei</option>
          <option value="Juni">Juni</option>
          <option value="Juli">Juli</option>
          <option value="Agustus">Agustus</option>
          <option value="September">September</option>
          <option value="Oktober">Oktober</option>
          <option value="November">November</option>
          <option value="Desember">Desember</option>
        </select>
      </div>
      <div class="form-group">
        <label>CH</label>
        <input type="text" name="ch_mrs" required />
      </div>
      <div class="form-group">
        <label>Nama Customer</label>
        <input type="text" name="nama_customer_mrs" required />
      </div>
      <div class="form-group">
        <label>No HP</label>
        <div style="display: flex; align-items: center;">
          <span style="background: #f0f0f0; padding: 10px; border: 1px solid #ccc; border-right: none; border-radius: 5px 0 0 5px; color: #666;">62</span>
          <input type="text" name="nohp_mrs" id="nohp_mrs_input" placeholder="812xxxxxxx" style="border-radius: 0 5px 5px 0; border-left: none;" required />
        </div>
      </div>
      <button type="submit">Simpan MRS</button>
    </form>
  </div>

  <!-- MRS VIEW -->
  <div id="mrsViewPage" class="hidden">
    <button onclick="showPage('mrsPage')">&larr; Kembali</button>
    <h3>View MRS</h3>
    <div>
      <label>Filter Bulan: 
        <select id="mrs-filter-month" onchange="loadMRSData()">
          <option value="">Semua Bulan</option>
          <option value="Januari">Januari</option>
          <option value="Februari">Februari</option>
          <option value="Maret">Maret</option>
          <option value="April">April</option>
          <option value="Mei">Mei</option>
          <option value="Juni">Juni</option>
          <option value="Juli">Juli</option>
          <option value="Agustus">Agustus</option>
          <option value="September">September</option>
          <option value="Oktober">Oktober</option>
          <option value="November">November</option>
          <option value="Desember">Desember</option>
        </select>
        <input type="number" id="mrs-filter-year" min="2020" max="2100" value="2025" style="width:80px; margin-left:10px;" onchange="loadMRSData()" />
      </label>
    </div>
    <div class="table-responsive">
      <table id="mrsTable" class="hidden">
        <thead>
          <tr>
            <th>No</th>
            <th>Nomor Polisi</th>
            <th>Bulan</th>
            <th>CH</th>
            <th>Nama Customer</th>
            <th>No HP</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- View MRS Section -->
  <div id="mrsViewByMonthPage" class="hidden">
    <button onclick="showPage('mrsPage')">&larr; Kembali</button>
    <h3>View MRS per Bulan</h3>
    <div>
      <label>Bulan:
        <select id="mrs-view-bulan">
          <option value="Januari">Januari</option>
          <option value="Februari">Februari</option>
          <option value="Maret">Maret</option>
          <option value="April">April</option>
          <option value="Mei">Mei</option>
          <option value="Juni">Juni</option>
          <option value="Juli">Juli</option>
          <option value="Agustus">Agustus</option>
          <option value="September">September</option>
          <option value="Oktober">Oktober</option>
          <option value="November">November</option>
          <option value="Desember">Desember</option>
        </select>
      </label>
      <label>Tahun:
        <input type="number" id="mrs-view-tahun" min="2020" max="2100" value="2025" style="width:80px;">
      </label>
      <button onclick="loadMRSView()">Lihat Data</button>
    </div>
    <div class="table-responsive">
      <table id="mrsViewTable" class="hidden">
        <thead>
          <tr>
            <th>No</th>
            <th>Nomor Polisi</th>
            <th>Bulan</th>
            <th>CH</th>
            <th>Nama Customer</th>
            <th>No HP</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

 
  <div id="infoCustomerPage" class="hidden">
    <button onclick="showPage('rekapSalesPage')">&larr; Kembali</button>
    <h3>Info Customer per Sales</h3>
    <div style="margin: 20px 0;">
      <label>Pilih Sales: <select id="customer-info-sales"></select></label>
      <button onclick="showCustomerInfo()">View</button>
    </div>
    <div id="customerInfoTableContainer"></div>
  </div>

  
  <div id="loadingIndicator" style="display:none;text-align:center;font-weight:bold;font-size:1.2em;margin:10px 0;">
    <span id="loadingText">MEMPROSES...</span> <span style="font-size:1.5em;">‚è≥</span>
  </div>
</div>

<script>
const URL = "https://script.google.com/macros/s/AKfycbzzz6ORbGD1ffUL3i5fUXn6YQn39In67JUt1Ji3HAvgRwmAE2Mh9xA5ibwkINipe2PC/exec";

function formatDateOnly(dateStr) {
  if (!dateStr) return "";
  if (dateStr instanceof Date) return dateStr.toISOString().split("T")[0];
  if (typeof dateStr === "string" && dateStr.includes("T")) return dateStr.split("T")[0];
  if (typeof dateStr === "string") return dateStr;
  return "";
}

function formatJam(jamStr) {
  if (!jamStr) return "";
  if (/^\d{1,2}:\d{2}$/.test(jamStr)) return jamStr;
  const date = new Date(jamStr);
  if (isNaN(date.getTime())) return jamStr;
  let hours = date.getHours();
  const minutes = date.getMinutes().toString().padStart(2, '0');
  const ampm = hours >= 12 ? 'PM' : 'AM';
  hours = hours % 12;
  hours = hours ? hours : 12;
  return `${hours}:${minutes} ${ampm}`;
}


function formatTanggalOnly(dateStr) {
  if (!dateStr) return '';
  if (dateStr instanceof Date) return dateStr.toISOString().split('T')[0];
  if (typeof dateStr === 'string' && dateStr.includes('T')) return dateStr.split('T')[0];
  if (typeof dateStr === 'string') return dateStr;
  return '';
}

const SALES_LIST = [
  'zen', 'januar', 'nia', 'avro', 'mila', 'indra', 'hendra', 'irvan', 'rony', 'stevy', 'osla', 'imron', 'asep aj', 'nadia', 'daulat', 'other'
];

function showLoading(text) {
  document.getElementById('loadingText').textContent = text || 'MEMPROSES...';
  document.getElementById('loadingIndicator').style.display = '';
}
function hideLoading() {
  document.getElementById('loadingIndicator').style.display = 'none';
}

function loadRekapSales() {
  showLoading('Memproses data rekap sales...');
  const selectedMonth = document.getElementById("rekap-sales-month").value;
  const selectedYear = document.getElementById("rekap-sales-year").value || new Date().getFullYear();
  
 
  fetch(`${URL}?action=get_all_booking`)
    .then(res => res.json())
    .then(data => {
      
      let filtered = data.filter(row => (row.via || '').toLowerCase() === 'tab');
      
      
      if (selectedMonth) {
        filtered = filtered.filter(row => {
          const bookingDate = new Date(row.tanggal_penerimaan || row.tanggal_booking || '');
          const bookingMonth = (bookingDate.getMonth() + 1).toString().padStart(2, '0');
          const bookingYear = bookingDate.getFullYear().toString();
          return bookingMonth === selectedMonth && bookingYear === selectedYear;
        });
      }
      
      renderRekapSalesTable(filtered);
      
      // Update chart data jika chart sedang ditampilkan
      if (!document.getElementById('salesChartsContainer').classList.contains('hidden')) {
        updateSalesCharts(filtered);
      }
      hideLoading();
    })
    .catch(err => {
      document.getElementById('rekapSalesTableContainer').innerHTML = `<p style='color:red'>Gagal memuat data: ${err}</p>`;
      hideLoading();
    });
}

function renderRekapSalesTable(rows) {
  const salesCount = {};
  SALES_LIST.forEach(s => salesCount[s] = 0);

  rows.forEach(row => {
    let salesVal = (row.nama_sales || row.sales || '').toString().trim().toLowerCase();
    if (SALES_LIST.includes(salesVal)) {
      salesCount[salesVal]++;
    }
  });

  // Urutkan sales berdasarkan jumlah booking (terbanyak di atas), lalu urut SALES_LIST jika sama
  const sortedSales = SALES_LIST
    .filter(s => s !== 'other')
    .sort((a, b) => {
      if (salesCount[b] !== salesCount[a]) return salesCount[b] - salesCount[a];
      return SALES_LIST.indexOf(a) - SALES_LIST.indexOf(b);
    });

  let html = `<table class="table table-bordered table-striped table-sm"><thead><tr>
    <th>No</th>
    <th>Nama Sales</th>
    <th>Jumlah Booking</th>
  </tr></thead><tbody>`;

  let idx = 1;
  sortedSales.forEach(sales => {
    html += `<tr>
      <td>${idx++}</td>
      <td>${sales.toUpperCase()}</td>
      <td>${salesCount[sales]}</td>
    </tr>`;
  });

  html += '</tbody></table>';
  document.getElementById('rekapSalesTableContainer').innerHTML = html;
}

function toggleOtherSalesInput(select, idx) {
  const val = select.value;
  const input = document.getElementById('other-sales-' + idx);
  if (val === 'other') {
    input.style.display = 'block';
  } else {
    input.style.display = 'none';
    input.value = '';
  }
}

function showCustomerInfo() {
  showLoading('Memproses data info customer...');
  const selectedMonth = document.getElementById("rekap-sales-month").value;
  const selectedYear = document.getElementById("rekap-sales-year").value || new Date().getFullYear();
  const selectedSales = document.getElementById('customer-info-sales').value;
  fetch(`${URL}?action=get_all_booking`)
    .then(res => res.json())
    .then(data => {
      // Filter hanya yang via = TAB, bulan/tahun, dan sales sesuai dropdown
      let filtered = data.filter(row => (row.via || '').toLowerCase() === 'tab');
      if (selectedMonth) {
        filtered = filtered.filter(row => {
          const bookingDate = new Date(row.tanggal_penerimaan || row.tanggal_booking || '');
          const bookingMonth = (bookingDate.getMonth() + 1).toString().padStart(2, '0');
          const bookingYear = bookingDate.getFullYear().toString();
          return bookingMonth === selectedMonth && bookingYear === selectedYear;
        });
      }
      filtered = filtered.filter(row => ((row.nama_sales || row.sales || '').toString().trim().toLowerCase() === selectedSales));
      
      let html = `<table class="table table-bordered table-striped table-sm"><thead><tr>
        <th>No</th>
        <th>Nomor Polisi</th>
        <th>Nama Customer</th>
        <th>Tanggal Penerimaan</th>
      </tr></thead><tbody>`;
      filtered.forEach((row, idx) => {
        html += `<tr>
          <td>${idx + 1}</td>
          <td>${row.nomor_polisi || row.plat || ''}</td>
          <td>${row.nama_customer || row.nama || ''}</td>
          <td>${formatTanggalOnly(row.tanggal_penerimaan || '')}</td>
        </tr>`;
      });
      html += '</tbody></table>';
      html += `<div style='margin-top:10px;'><strong>Total Data: ${filtered.length}</strong></div>`;
      document.getElementById('customerInfoTableContainer').innerHTML = html;
      hideLoading();
    })
    .catch(err => {
      document.getElementById('customerInfoTableContainer').innerHTML = `<p style='color:red'>Gagal memuat data: ${err}</p>`;
      hideLoading();
    });
}

function showSalesCharts() {
  document.getElementById('rekapSalesTableContainer').innerHTML = '';
  document.getElementById('salesChartsContainer').classList.remove('hidden');
  loadRekapSales(); // Ini akan memanggil updateSalesCharts
}

function updateSalesCharts(data) {
  const salesStats = {};
  SALES_LIST.forEach(sales => {
    salesStats[sales] = 0;
  });
  
  data.forEach(row => {
    const salesName = (row.nama_sales || row.sales || '').toLowerCase();
    if (salesStats.hasOwnProperty(salesName)) {
      salesStats[salesName]++;
    }
  });

  const salesWithData = Object.entries(salesStats).filter(([_, count]) => count > 0);
  

  salesWithData.sort((a, b) => b[1] - a[1]);
  

  const labels = salesWithData.map(([sales, _]) => sales.toUpperCase());
  const values = salesWithData.map(([_, count]) => count);
  const colors = generateColors(salesWithData.length);
  
 
  renderPieChart(labels, values, colors);
  

  renderBarChart(labels, values, colors);
  

  updateSalesSummary(salesWithData);
}

function renderPieChart(labels, values, colors) {
  const canvas = document.getElementById('salesPieChart');
  const ctx = canvas.getContext('2d');
  
  
  const centerX = canvas.width / 2;
  const centerY = canvas.height / 2;
  const radius = Math.min(centerX, centerY) - 50;
  
  const total = values.reduce((sum, val) => sum + val, 0);
  let currentAngle = 0;
  

  values.forEach((value, index) => {
    const sliceAngle = (value / total) * 2 * Math.PI;
    
    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
    ctx.closePath();
    ctx.fillStyle = colors[index];
    ctx.fill();
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2;
    ctx.stroke();
    

    const labelAngle = currentAngle + sliceAngle / 2;
    const labelRadius = radius + 30;
    const labelX = centerX + Math.cos(labelAngle) * labelRadius;
    const labelY = centerY + Math.sin(labelAngle) * labelRadius;
    
    ctx.fillStyle = '#000';
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(`${labels[index]}: ${value}`, labelX, labelY);
    
    currentAngle += sliceAngle;
  });
}

function renderBarChart(labels, values, colors) {
  const canvas = document.getElementById('salesBarChart');
  const ctx = canvas.getContext('2d');
  
  
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  const maxValue = Math.max(...values);
  const barWidth = 30;
  const barSpacing = 20;
  const chartHeight = canvas.height - 100;
  const chartWidth = labels.length * (barWidth + barSpacing);
  const startX = (canvas.width - chartWidth) / 2;
  

  labels.forEach((label, index) => {
    const barHeight = (values[index] / maxValue) * chartHeight;
    const x = startX + index * (barWidth + barSpacing);
    const y = canvas.height - 80 - barHeight;
    

    ctx.fillStyle = colors[index];
    ctx.fillRect(x, y, barWidth, barHeight);
    
  
    ctx.fillStyle = '#000';
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(values[index], x + barWidth / 2, y - 5);
    
   
    ctx.fillText(label, x + barWidth / 2, canvas.height - 20);
  });
}

function updateSalesSummary(salesWithData) {
  if (salesWithData.length === 0) {
    document.getElementById('salesSummaryContent').innerHTML = '<p>Tidak ada data booking untuk periode yang dipilih.</p>';
    return;
  }
  
  const selectedMonth = document.getElementById("rekap-sales-month").value;
  const selectedYear = document.getElementById("rekap-sales-year").value || new Date().getFullYear();
  
  const topSales = salesWithData[0];
  const totalBookings = salesWithData.reduce((sum, [_, count]) => sum + count, 0);
  
  let html = `
    <p><strong>Periode:</strong> ${selectedMonth ? getMonthName(selectedMonth) + ' ' + selectedYear : 'Semua Periode'}</p>
    <p><strong>Total Booking:</strong> ${totalBookings}</p>
    <p><strong>Sales Terbanyak:</strong> ${topSales[0].toUpperCase()} dengan ${topSales[1]} booking</p>
    <p><strong>Persentase Sales Terbanyak:</strong> ${((topSales[1] / totalBookings) * 100).toFixed(1)}%</p>
  `;
  
  document.getElementById('salesSummaryContent').innerHTML = html;
}

function generateColors(count) {
  const colors = [
    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
    '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384',
    '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
  ];
  
  return colors.slice(0, count);
}

function getMonthName(monthNumber) {
  const months = [
    'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
    'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
  ];
  return months[parseInt(monthNumber) - 1];
}

function updateSalesRekapSpreadsheet() {
  showLoading('Mengupdate data Sales Rekap...');
  const selectedMonth = document.getElementById("rekap-sales-month").value;
  const selectedYear = document.getElementById("rekap-sales-year").value || new Date().getFullYear();
  if (!selectedMonth || !selectedYear) {
    alert('Pilih bulan dan tahun terlebih dahulu!');
    hideLoading();
    return;
  }
  if (!confirm('Yakin ingin mengupdate spreadsheet Sales Rekap untuk bulan ini?')) {
    hideLoading();
    return;
  }
  const params = new URLSearchParams();
  params.append("action", "update_sales_rekap");
  params.append("bulan", selectedMonth);
  params.append("tahun", selectedYear);
  fetch(URL, {
    method: "POST",
    body: params
  })
    .then(res => res.text())
    .then(msg => {
      alert(msg);
      hideLoading();
    })
    .catch(err => {
      alert("Gagal mengupdate spreadsheet: " + err);
      hideLoading();
    });
}

function showPage(id) {
  ["loginPage", "dashboardPage", "bookingPage", "dataPage", "rekapPage", "mrsPage", "mrsInputPage", "mrsViewPage", "mrsViewByMonthPage", "rekapSalesPage", "infoCustomerPage"].forEach(p => document.getElementById(p).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  if (id === 'rekapSalesPage') {
    loadRekapSales();

    document.getElementById('salesChartsContainer').classList.add("hidden");
    populateCustomerInfoSalesDropdown(); 
  }
  if (id === 'infoCustomerPage') {
    populateCustomerInfoSalesDropdown(); 
  }
  hideLoading();
}

function checkLogin() {
  if (localStorage.getItem("isLoggedIn") === "true") {
    showPage("dashboardPage");
  } else {
    showPage("loginPage");
  }
}

function logout() {
  localStorage.removeItem("isLoggedIn");
  checkLogin();
}

document.getElementById("loginForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const username = e.target.username.value.trim();
  const password = e.target.password.value.trim();
  if (username === "agmeylanecha@gmail.com" && password === "saturjeff") {
    localStorage.setItem("isLoggedIn", "true");
    showPage("dashboardPage");
    e.target.reset();
  } else {
    alert("Email atau password salah!");
  }
});

document.getElementById("bookingForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const form = e.target;
  const formData = new FormData(form);
  const params = new URLSearchParams();
  

  const tipeTelepon = form.tipe_telepon.value;
  if (tipeTelepon === "SA") {
    formData.set("nohp", form.nohp_sa.value);
    formData.set("datang", form.datang_dropdown.value);
  } else {
    const noHpInput = document.getElementById("nohp_input").value;
    if (noHpInput) {
      const cleanNumber = noHpInput.replace(/^62/, '');
      formData.set("nohp", "62" + cleanNumber);
    } else {
      formData.set("nohp", "");
    }
    formData.set("datang", form.datang.value);
  }
  
 
  let salesValue = form.sales.value;
  if (salesValue === 'other') {
    salesValue = form.sales_other.value;
  }
  formData.set('sales', salesValue);

  formData.forEach((v, k) => params.append(k, v));

  const isEdit = form.editId.value !== "";
  if (isEdit) {
    params.append("id_row", form.editId.value);
    params.append("sheetName", form.sheetName.value);
    params.append("action", "edit");
    params.append("status_kehadiran", document.getElementById("status_kehadiran_select").value);
  }

  fetch(URL, {
    method: "POST",
    body: params
  })
    .then(res => res.text())
    .then(msg => {
      alert(msg);
      if (isEdit) {
        
        document.getElementById("editId").value = "";
        document.getElementById("sheetName").value = "";
        showPage("dataPage");
        loadData();
      } else {
        
        form.reset();
        
        document.getElementById("phoneInputGroup").style.display = "none";
        document.getElementById("saPhoneGroup").style.display = "none";
      }
    })
    .catch(err => {
      alert("Gagal menyimpan data: " + err);
    });
});

function loadData() {
  showLoading('Memproses data booking...');
  const tanggal = document.getElementById("filter-date").value;
  if (!tanggal) {
    alert("Pilih tanggal dulu!");
    hideLoading();
    return;
  }

  fetch(`${URL}?tanggal_penerimaan=${tanggal}`)
    .then(res => res.json())
    .then(data => {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";

      if (data.length === 0) {
        tbody.innerHTML = "<tr><td colspan='15'>Tidak ada data</td></tr>";
        document.getElementById("dataTable").classList.remove("hidden");
        hideLoading();
        return;
      }

      data.forEach((row, idx) => {
        
        const status = row.status_kehadiran || "";
        const displayStatus = status || "-"; 
        
        const tds = `
          <td>${idx + 1}</td>
          <td>${displayStatus}</td>
          <td>${row.nomor_polisi || row.plat || ""}</td>
          <td>${row.tipe_kendaraan || row.tipe || ""}</td>
          <td>${row.tahun || ""}</td>
          <td>${row.no_hp || row.nohp || ""}</td>
          <td>${row.customer_akan_datang || row.datang || ""}</td>
          <td>${row.nama_customer || row.nama || ""}</td>
          <td>${formatDateOnly(row.tanggal_booking)}</td>
          <td>${formatDateOnly(row.tanggal_penerimaan)}</td>
          <td>${formatJam(row.jam_penerimaan || "")}</td>
          <td>${row.via || ""}</td>
          <td>${row.admin || ""}</td>
          <td>${row.jenis_pekerjaan || row.keluhan || ""}</td>
          <td>${row.nama_sales || row.sales || ""}</td>
          <td>
            <button onclick='editRow(${JSON.stringify(row)})'>Edit</button>
            <button onclick='deleteRow("${row.id_row}", "${row.tanggal_penerimaan}", "${row.sheetName}", this)'>Hapus</button>
          </td>
        `;
        const tr = document.createElement("tr");
        tr.innerHTML = tds;
        tbody.appendChild(tr);
      });

      document.getElementById("dataTable").classList.remove("hidden");
      hideLoading();
    })
    .catch(err => {
      alert("Gagal memuat data: " + err);
      hideLoading();
    });
}


function showNewBookingForm() {
  showPage("bookingPage");
  const form = document.getElementById("bookingForm");
  form.reset();
  document.getElementById("editId").value = "";
  document.getElementById("sheetName").value = "";
  document.getElementById("submitBtn").textContent = "Kirim";
  document.getElementById("statusGroup").classList.add("hidden");
  document.getElementById("tipe_telepon").value = "";
  document.getElementById("phoneInputGroup").style.display = "none";
  document.getElementById("saPhoneGroup").style.display = "none";
  document.getElementById("customerDatangGroup").style.display = "block";
  document.getElementById("customerDatangDropdown").style.display = "none";
  document.getElementById("datang_input").value = "";
  document.getElementById("datang_select").value = "";
}

function togglePhoneInput() {
  const tipeTelepon = document.getElementById("tipe_telepon").value;
  if (tipeTelepon === "SA") {
    document.getElementById("phoneInputGroup").style.display = "none";
    document.getElementById("saPhoneGroup").style.display = "block";
    document.getElementById("customerDatangGroup").style.display = "none";
    document.getElementById("customerDatangDropdown").style.display = "block";
  } else {
    document.getElementById("phoneInputGroup").style.display = "block";
    document.getElementById("saPhoneGroup").style.display = "none";
    document.getElementById("customerDatangGroup").style.display = "block";
    document.getElementById("customerDatangDropdown").style.display = "none";
  }
}


function formatPhoneNumber(input) {
  let value = input.value.replace(/\D/g, ''); 
  
  
  if (value.startsWith('62')) {
    value = value.substring(2);
  }
  
  
  if (value.length > 12) {
    value = value.substring(0, 12);
  }
  
  input.value = value;
}


document.addEventListener('DOMContentLoaded', function() {
  const phoneInput = document.getElementById('nohp_input');
  if (phoneInput) {
    phoneInput.addEventListener('input', function() {
      formatPhoneNumber(this);
    });
    
    
    phoneInput.addEventListener('paste', function(e) {
      e.preventDefault();
      const pastedText = (e.clipboardData || window.clipboardData).getData('text');
      let cleanText = pastedText.replace(/\D/g, '');
      if (cleanText.startsWith('62')) {
        cleanText = cleanText.substring(2);
      }
      if (cleanText.length > 12) {
        cleanText = cleanText.substring(0, 12);
      }
      this.value = cleanText;
    });
  }
  
  
  const currentMonth = new Date().toLocaleString('id-ID', { month: 'long' });
  const reminderMonthSelect = document.querySelector('select[name="reminder_month"]');
  if (reminderMonthSelect) {
    reminderMonthSelect.value = currentMonth;
  }
});


document.getElementById("mrsForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const form = e.target;
  const formData = new FormData(form);
  const params = new URLSearchParams();
  
  let nohp = form.nohp_mrs.value.replace(/\D/g, '');
  if (nohp.startsWith('62')) nohp = nohp.substring(2);
  params.append("nohp_mrs", "62" + nohp);
  formData.forEach((v, k) => {
    if (k !== "nohp_mrs") params.append(k, v);
  });
  params.append("action", "add_mrs");

  fetch(URL, {
    method: "POST",
    body: params
  })
    .then(res => res.text())
    .then(msg => {
      alert(msg);
      form.reset();
      document.getElementById("reminder_month_select").value = new Date().toLocaleString('id-ID', { month: 'long' });
    })
    .catch(err => {
      alert("Gagal menyimpan data MRS: " + err);
    });
});

function loadMRSData() {
  showLoading('Memproses data MRS...');
  const selectedMonth = document.getElementById("mrs-filter-month").value;
  const selectedYear = document.getElementById("mrs-filter-year").value || new Date().getFullYear();
  if (!selectedMonth || !selectedYear) {
    document.querySelector("#mrsTable tbody").innerHTML = "<tr><td colspan='7'>Pilih bulan dan tahun</td></tr>";
    document.getElementById("mrsTable").classList.remove("hidden");
    hideLoading();
    return;
  }
  fetch(`${URL}?action=get_mrs_view&bulan=${selectedMonth}&tahun=${selectedYear}`)
    .then(res => res.json())
    .then(data => {
      const tbody = document.querySelector("#mrsTable tbody");
      tbody.innerHTML = "";
      if (data.length === 0) {
        tbody.innerHTML = "<tr><td colspan='7'>Tidak ada data MRS</td></tr>";
        document.getElementById("mrsTable").classList.remove("hidden");
        hideLoading();
        return;
      }
      data.forEach((row, idx) => {
        const waNumber = row.no_hp || "";
        const pesan =
`Yth. Bapak/Ibu ${row.nama_customer || ''}\nKami mengingatkan untuk kendaraan ${row.nomor_polisi || ''} sudah waktunya service berkala (${row.ch || ''}) atau 6 bulan setelah service kendaraan\n\nApakah Bapak/Ibu bersedia kami booking kan di Bulan ${row.bulan || ''} ${selectedYear}?\n\nBOOKING Maksimal H-2 / H-1 sebelum service\n\nAbaikan pesan ini jika sudah melakukan service\n\nKami pun memiliki layanan THS - Auto2000 Home Service yang dapat melakukan service di tempat anda (rumah/kantor, dsb). \n\nCintai Keluarga dan Kendaraan Anda!\n\nHotline : 022-602.2000 / 6010010\n\nSenin - Jum'at : 08.00 s/d 16.00\nSabtu : 08.00 s/d 13:00\nHari Minggu dan hari besar operasional booking service Libur.\n\nJl. Soekarno Hatta No. 145 Bandung ( Caringin )`;
        const waLinkApp = `https://wa.me/${waNumber}?text=${encodeURIComponent(pesan)}`;
        const waLinkWeb = `https://web.whatsapp.com/send?phone=${waNumber}&text=${encodeURIComponent(pesan)}`;
        const tds = `
          <td>${idx + 1}</td>
          <td>${row.nomor_polisi || ""}</td>
          <td>${row.bulan || ""}</td>
          <td>${row.ch || ""}</td>
          <td>${row.nama_customer || ""}</td>
          <td>${waNumber}</td>
          <td>
            <button onclick='deleteMRS("${row.id_row}", this)'>Hapus</button>
            <a href="${waLinkApp}" target="_blank" title="Kirim via WhatsApp App">
              <img src='https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg' alt='WA App' style='width:24px;height:24px;vertical-align:middle;'>
            </a>
            <a href="${waLinkWeb}" target="_blank" title="Kirim via WhatsApp Web">
              <img src='https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg' alt='WA Web' style='width:24px;height:24px;vertical-align:middle;filter: grayscale(100%) brightness(0.7);'>
            </a>
          </td>
        `;
        const tr = document.createElement("tr");
        tr.innerHTML = tds;
        tbody.appendChild(tr);
      });
      document.getElementById("mrsTable").classList.remove("hidden");
      hideLoading();
    })
    .catch(err => {
      alert("Gagal memuat data MRS: " + err);
      hideLoading();
    });
}

function deleteMRS(id_row, btn) {
  if (!confirm("Yakin ingin hapus data MRS ini?")) return;
  
  if (btn) {
    btn.disabled = true;
    btn.textContent = "Menghapus...";
  }
  
  const params = new URLSearchParams();
  params.append("action", "delete_mrs");
  params.append("id_row", id_row);

  fetch(URL, {
    method: "POST",
    body: params
  })
    .then(res => res.text())
    .then(msg => {
      alert(msg);
      loadMRSData();
    })
    .catch(err => {
      alert("Gagal menghapus data MRS: " + err);
    })
    .finally(() => {
      if (btn) {
        btn.disabled = false;
        btn.textContent = "Hapus";
      }
    });
}

function editRow(row) {
  showPage("bookingPage");
  const form = document.getElementById("bookingForm");
  form.plat.value = row.nomor_polisi || "";
  document.getElementById("statusGroup").classList.remove("hidden");
  document.getElementById("status_kehadiran_select").value = row.status_kehadiran || "show";
  form.tipe.value = row.tipe_kendaraan || "";
  form.tahun.value = row.tahun || "";
  

  const tipeTelepon = row.tipe_telepon || "";
  form.tipe_telepon.value = tipeTelepon;
  if (tipeTelepon === "SA") {
    document.getElementById("phoneInputGroup").style.display = "none";
    document.getElementById("saPhoneGroup").style.display = "block";
    document.getElementById("nohp_sa_select").value = row.no_hp || row.nohp || "";
    document.getElementById("nohp_input").value = "";
    
    
    document.getElementById("customerDatangGroup").style.display = "none";
    document.getElementById("customerDatangDropdown").style.display = "block";
    document.getElementById("datang_select").value = row.customer_akan_datang || row.datang || "";
    document.getElementById("datang_input").value = "";
  } else {
    document.getElementById("phoneInputGroup").style.display = "block";
    document.getElementById("saPhoneGroup").style.display = "none";
    
    const phoneNumber = row.no_hp || row.nohp || "";
    const displayNumber = phoneNumber.startsWith("62") ? phoneNumber.substring(2) : phoneNumber;
    document.getElementById("nohp_input").value = displayNumber;
    document.getElementById("nohp_sa_select").value = "";
    
    
    document.getElementById("customerDatangGroup").style.display = "block";
    document.getElementById("customerDatangDropdown").style.display = "none";
    document.getElementById("datang_input").value = row.customer_akan_datang || row.datang || "";
    document.getElementById("datang_select").value = "";
  }
  
  
  let salesVal = row.nama_sales || row.sales || "";
  const salesSelect = document.getElementById("sales_select");
  const salesOtherInput = document.getElementById("sales_other_input");
  if (["zen","januar","nia","avro","mila","indra","hendra","irvan","rony","stevy","osla","imron","asep aj","nadia","daulat"].includes(salesVal.toLowerCase())) {
    salesSelect.value = salesVal.toLowerCase();
    salesOtherInput.style.display = 'none';
    salesOtherInput.value = '';
  } else if (salesVal) {
    salesSelect.value = 'other';
    salesOtherInput.style.display = 'block';
    salesOtherInput.value = salesVal;
  } else {
    salesSelect.value = '';
    salesOtherInput.style.display = 'none';
    salesOtherInput.value = '';
  }
  
  
  
  form.nama.value = row.nama_customer || "";
  form.tanggal_penerimaan.value = row.tanggal_penerimaan || "";
  form.jam_penerimaan.value = row.jam_penerimaan || "";
  form.via.value = row.via || "";
  form.admin.value = row.admin || "";
  form.keluhan.value = row.jenis_pekerjaan || "";
  form.sales.value = row.nama_sales || "";

  document.getElementById("editId").value = row.id_row;
  document.getElementById("sheetName").value = row.sheetName;
  document.getElementById("submitBtn").textContent = "Update Data";
}


function deleteRow(id_row, tanggal, sheetName, btn) {
  if (!confirm("Yakin ingin hapus data ini?")) return;
  if (btn) {
    btn.disabled = true;
    btn.textContent = "Menghapus...";
  }
  const params = new URLSearchParams();
  params.append("id_row", id_row);
  params.append("tanggal_penerimaan", tanggal);
  params.append("sheetName", sheetName);
  params.append("action", "delete");

  fetch(URL, {
    method: "POST",
    body: params
  })
    .then(res => res.text())
    .then(msg => {
      alert(msg);
      loadData();
    })
    .catch(err => {
      alert("Gagal menghapus data: " + err);
    })
    .finally(() => {
      if (btn) {
        btn.disabled = false;
        btn.textContent = "Hapus";
      }
    });
}

function loadRekap() {
  showLoading('Memproses data rekap...');
  const tanggal = document.getElementById("rekap-filter-date").value;
  if (!tanggal) {
    alert("Pilih tanggal dulu!");
    hideLoading();
    return;
  }

  fetch(`${URL}?tanggal_penerimaan=${tanggal}`)
    .then(res => res.json())
    .then(data => {
      const tbody = document.querySelector("#rekapTable tbody");
      tbody.innerHTML = "";

      if (data.length === 0) {
        tbody.innerHTML = "<tr><td colspan='9'>Tidak ada data</td></tr>";
        document.getElementById("rekapTable").classList.remove("hidden");
        document.getElementById("rekapSummary").classList.add("hidden");
        document.getElementById("exportBtn").classList.add("hidden");
        hideLoading();
        return;
      }

      
      let showCount = 0, noShowCount = 0, rescheduleCount = 0, unknownCount = 0;
      
      data.forEach((row, idx) => {
        const status = row.status_kehadiran || "";
        if (status === "show") showCount++;
        else if (status === "no show") noShowCount++;
        else if (status === "reschedule") rescheduleCount++;
        else unknownCount++; 

        const displayStatus = status || "-"; 

        const tds = `
          <td>${idx + 1}</td>
          <td>${displayStatus}</td>
          <td>${row.nomor_polisi || row.plat || ""}</td>
          <td>${row.nama_customer || row.nama || ""}</td>
          <td>${formatDateOnly(row.tanggal_penerimaan)}</td>
          <td>${formatJam(row.jam_penerimaan || "")}</td>
          <td>${row.via || ""}</td>
          <td>${row.admin || ""}</td>
          <td>${row.nama_sales || row.sales || ""}</td>
        `;
        const tr = document.createElement("tr");
        tr.innerHTML = tds;
        tbody.appendChild(tr);
      });

      
      document.getElementById("showCount").textContent = showCount;
      document.getElementById("noShowCount").textContent = noShowCount;
      document.getElementById("rescheduleCount").textContent = rescheduleCount;
      document.getElementById("totalCount").textContent = data.length;

      document.getElementById("rekapTable").classList.remove("hidden");
      document.getElementById("rekapSummary").classList.remove("hidden");
      document.getElementById("exportBtn").classList.remove("hidden");
      hideLoading();
    })
    .catch(err => {
      alert("Gagal memuat data rekap: " + err);
      hideLoading();
    });
}

function exportRekapToSpreadsheet() {
  showLoading('Mengekspor data rekap...');
  const tanggal = document.getElementById("rekap-filter-date").value;
  if (!tanggal) {
    alert("Pilih tanggal dulu!");
    hideLoading();
    return;
  }

  const params = new URLSearchParams();
  params.append("action", "export_rekap");
  params.append("tanggal_penerimaan", tanggal);

  fetch(URL, {
    method: "POST",
    body: params
  })
    .then(res => res.text())
    .then(msg => {
      alert(msg);
    })
    .catch(err => {
      alert("Gagal export ke spreadsheet: " + err);
    });
  hideLoading();
}

function loadMRSView() {
  showLoading('Memproses data MRS View...');
  const bulan = document.getElementById("mrs-view-bulan").value;
  const tahun = document.getElementById("mrs-view-tahun").value;
  fetch(`${URL}?action=get_mrs_view&bulan=${bulan}&tahun=${tahun}`)
    .then(res => res.json())
    .then(data => {
      const tbody = document.querySelector("#mrsViewTable tbody");
      tbody.innerHTML = "";
      if (data.length === 0) {
        tbody.innerHTML = "<tr><td colspan='7'>Tidak ada data MRS</td></tr>";
        document.getElementById("mrsViewTable").classList.remove("hidden");
        hideLoading();
        return;
      }
      data.forEach((row, idx) => {
        const ch = row.ch || "";
        const namaCustomer = row.nama_customer || "";
        const waNumber = row.no_hp || "";
        const pesan =
`Yth. Bapak/Ibu ${namaCustomer}\nKami mengingatkan untuk kendaraan ${row.nomor_polisi || ""} sudah waktunya service berkala (${ch}) atau 6 bulan setelah service kendaraan\n\nApakah Bapak/Ibu bersedia kami booking kan di Bulan ${row.bulan || ""} ${tahun}?\n\nBOOKING Maksimal H-2 / H-1 sebelum service\n\nAbaikan pesan ini jika sudah melakukan service\n\nKami pun memiliki layanan THS - Auto2000 Home Service yang dapat melakukan service di tempat anda (rumah/kantor, dsb). \n\nCintai Keluarga dan Kendaraan Anda!\n\nHotline : 022-602.2000 / 6010010\n\nSenin - Jum'at : 08.00 s/d 16.00\nSabtu : 08.00 s/d 13:00\nHari Minggu dan hari besar operasional booking service Libur.\n\nJl. Soekarno Hatta No. 145 Bandung ( Caringin )`;
        const waLinkApp = `https://wa.me/${waNumber}?text=${encodeURIComponent(pesan)}`;
        const waLinkWeb = `https://web.whatsapp.com/send?phone=${waNumber}&text=${encodeURIComponent(pesan)}`;
        const tds = `
          <td>${idx + 1}</td>
          <td>${row.nomor_polisi || ""}</td>
          <td>${row.bulan || ""}</td>
          <td>${ch}</td>
          <td>${namaCustomer}</td>
          <td>${waNumber}</td>
          <td>
            <button onclick="deleteMRSView(${idx})" title="Hapus" style="background:#b30000;color:white;border:none;padding:6px 12px;border-radius:5px;">Hapus</button>
            <a href="${waLinkApp}" target="_blank" title="Kirim via WhatsApp App">
              <img src='https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg' alt='WA App' style='width:24px;height:24px;vertical-align:middle;'>
            </a>
            <a href="${waLinkWeb}" target="_blank" title="Kirim via WhatsApp Web">
              <img src='https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg' alt='WA Web' style='width:24px;height:24px;vertical-align:middle;filter: grayscale(100%) brightness(0.7);'>
            </a>
          </td>
        `;
        const tr = document.createElement("tr");
        tr.innerHTML = tds;
        tbody.appendChild(tr);
      });
      document.getElementById("mrsViewTable").classList.remove("hidden");
      hideLoading();
    })
    .catch(err => {
      alert("Gagal memuat data MRS: " + err);
      hideLoading();
    });
}

function sendWhatsApp(waNumber, pesan) {
  if (confirm("Pastikan nomor sudah terdaftar di WhatsApp. Lanjutkan kirim pesan?")) {
    const waLink = `https://wa.me/${waNumber}?text=${pesan}`;
    window.open(waLink, '_blank');
  }
}

function editMRS(idx) {
  alert('Fitur edit MRS belum diimplementasikan. Index data: ' + idx);
}

function deleteMRSView(idx) {
  alert('Fitur hapus MRS dari View belum diimplementasikan. Index data: ' + idx);
}

function toggleOtherSalesBooking() {
  const select = document.getElementById('sales_select');
  const input = document.getElementById('sales_other_input');
  if (select.value === 'other') {
    input.style.display = 'block';
  } else {
    input.style.display = 'none';
    input.value = '';
  }
}

function populateCustomerInfoSalesDropdown() {
  const select = document.getElementById('customer-info-sales');
  select.innerHTML = SALES_LIST.filter(s => s !== 'other').map(s => `<option value="${s}">${s.toUpperCase()}</option>`).join('');
}

window.onload = checkLogin;
</script>
</body>
</html>